<!--post_detail-->
{% extends 'zz/base.html' %}
{% load i18n %}

{% block content %}
<h3>Post detail</h3>
<h1>{{ chapter.title }}</h1>
<p>{{ chapter.description }}</p>


<div class="post">
    <h1>{{ post.title }}</h1>
    <p>{{ post.content|truncatewords:30 }}</p>
    <p><small>{{ post.created_at }}</small></p>

    {% if post.pk %}     
    <a href="{% url 'zz:post_update' post.pk %}" class="btn btn-secondary">Edit</a>

    <form action="{% url 'zz:post_delete' post.pk %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-danger">
            Delete
        </button>
    </form>

    <button id="summarize-btn" class="btn btn-warning">Summarize</button>
    <div id="summary-box"></div>

    {% endif %}
</div>

    <h3>{% trans "Add a comment " %}</h3>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">{% trans "Send" %}</button>
    </form>
    <h3>{% trans "Comments" %}</h3>

    <!--call ubludok button-->
    <form action="{% url 'zz:summon_ubludok' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="post_id" value="{{ post.pk }}">
        <input type="hidden" name="next" value="{{ request.path }}">
        <button type="submit" class="btn btn-danger">
            {% trans "Позвать ублюдка" %}
        </button>
    </form>


    <ul class="list-unstyled">
        {% for comment in comments %}
            
                {% include "zz/comment.html" with comment=comment %}
        {% empty %}
                <li>{% trans "No comments yet" %}</li>
            
        {% endfor %}
    </ul>

<script>
const btn = document.getElementById("summarize-btn");
btn.addEventListener("click", function(){
    fetch("{% url 'zz:post_summarize' post.pk %}", {
        method: "POST",
        headers: {"X-CSRFToken": "{{ csrf_token }}"}
    })
    .then(r => r.json())
    .then(data => {
        console.log("Launched", data);
        let taskId = data.task_id;

        //we start querying the status
        const interval = setInterval(() => {
            fetch(`{% url 'zz:post_summarize' post.pk %}?task_id=${taskId}`)
            .then(r => r.json())
            .then(statusData => {
                console.log("Status:", statusData);
                if (statusData.status === "done") {
                    clearInterval(interval);
                    document.getElementById("summary-box").innerHTML =
                        `<p><strong>Resume:</strong>${statusData.summary}</p>`;
                }
            });
        }, 2000);
    });
});
</script>

{% endblock %}