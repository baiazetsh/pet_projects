{% extends 'zz/base.html' %}
{% load i18n %}

{% block content %}
<h3>Post detail</h3>

<h1>{{ chapter.title }}</h1>
<p>{{ chapter.description }}</p>

<div class="post">
  <h1>{{ post.title }}</h1>
  <p>{{ post.content }}</p>
  <p><small>{{ post.created_at }}</small></p>

  {% if post.pk %}
  <a href="{% url 'zz:post_update' post.pk %}" class="btn btn-secondary">Edit</a>

  <form action="{% url 'zz:post_delete' post.pk %}" method="post" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="btn btn-sm btn-outline-danger">
      Delete
    </button>
  </form>

  <!-- Summarize -->
  <button id="summarize-btn" class="btn btn-warning">Summarize</button>
  <div id="summary-box"></div>
  {% endif %}
</div>

<hr>

<!-- Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° -->
<h3>{% trans "Add a comment" %}</h3>
<form id="commentForm" method="post" action="{% url 'zz:post_detail' post.pk %}">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit" class="btn btn-primary">{% trans "Send" %}</button>
</form>

<hr>

<!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð²Ñ‹Ð·Ð¾Ð²Ð° ÑƒÐ±Ð»ÑŽÐ´ÐºÐ° -->
<button id="ubludokBtn"
        data-url="{% url 'zz:summon_ubludok' post.pk %}"
        class="btn btn-danger">
  {% trans "Call the Ubludok" %}
</button>
<div id="ubludok-status" class="mt-2 text-muted"></div>
<hr>

<!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ² -->
<h3>{% trans "Comments" %}</h3>
<ul id="comments-list">
  {% for comment in comments %}
    {% include "comments/_comment.html" with comment=comment %}
  {% empty %}
    <li>{% trans "No comments yet" %}</li>
  {% endfor %}
</ul>




<script>
const CSRF = document.querySelector("[name=csrfmiddlewaretoken]").value;
const commentsList = document.getElementById("comments-list");

// ----- Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° -----
const mainForm = document.getElementById("commentForm");
if (mainForm) {
  mainForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(mainForm);

    try {
      const res = await fetch(mainForm.action, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
        body: formData,
      });

      const data = await res.json();
      if (data.success) {
        mainForm.reset();
      } else {
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ñ‹:", data.errors || data);
      }
    } catch (err) {
      console.error("Ð¡ÐµÑ‚ÑŒ/ÑÐµÑ€Ð²ÐµÑ€ Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ñ‹:", err);
    }
  });
}

// ----- Reply Ñ„Ð¾Ñ€Ð¼Ñ‹ -----
function bindReplyForm(form) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    try {
      const res = await fetch(window.location.pathname, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
        body: formData,
      });

      const data = await res.json();
      if (data.success) {
        form.reset();
      } else {
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ¿Ð»Ð°Ñ:", data.errors || data);
      }
    } catch (err) {
      console.error("Ð¡ÐµÑ‚ÑŒ/ÑÐµÑ€Ð²ÐµÑ€ Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ñ€ÐµÐ¿Ð»Ð°Ñ:", err);
    }
  });
}
document.querySelectorAll(".reply-form").forEach(bindReplyForm);

// ----- Ð£Ð±Ð»ÑŽÐ´Ð¾Ðº -----
const ubludokBtn = document.getElementById("ubludokBtn");
const statusBox = document.getElementById("ubludok-status");

if (ubludokBtn) {
  ubludokBtn.addEventListener("click", async () => {
    const url = ubludokBtn.dataset.url;
    statusBox.textContent = "âš¡ ÐŸÑ€Ð¸Ð·Ñ‹Ð²Ð°ÑŽ Ð½ÐµÐ¹Ñ€Ð¾ÑƒÐ±Ð»ÑŽÐ´ÐºÐ°...";

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
      });

      const data = await res.json();
      if (data.success) {
        statusBox.textContent = "âœ… Ð£Ð±Ð»ÑŽÐ´Ð¾Ðº Ð²Ñ‹Ð·Ð²Ð°Ð½!";
      } else {
        statusBox.textContent = "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ð·Ð¾Ð²Ð° ÑƒÐ±Ð»ÑŽÐ´ÐºÐ°.";
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ð·Ð¾Ð²Ð°:", data);
      }
    } catch (err) {
      statusBox.textContent = "ðŸš¨ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸ Ð¿Ñ€Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ðµ ÑƒÐ±Ð»ÑŽÐ´ÐºÐ°.";
      console.error("Ð¡ÐµÑ‚ÑŒ Ð¿Ñ€Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ðµ ÑƒÐ±Ð»ÑŽÐ´ÐºÐ°:", err);
    }
  });
}

// ----- Summarize -----

const summarizeBtn = document.getElementById("summarize-btn");
const summaryBox = document.getElementById("summary-box");

if (summarizeBtn) {
  summarizeBtn.addEventListener("click", async () => {
    summarizeBtn.disabled = true;
    summarizeBtn.textContent = "â³ Summarizing...";
    summaryBox.textContent = "";

    try {
      const res = await fetch("{% url 'zz:post_summarize' post.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await res.json();
      if (!data.task_id) {
        summaryBox.textContent = "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð·Ð°Ð´Ð°Ñ‡Ð° Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°.";
        return;
      }

      const taskId = data.task_id;
      let attempts = 0;
      const maxAttempts = 80;

      async function pollStatus() {
        const statusRes = await fetch(`{% url 'zz:post_summarize' post.pk %}?task_id=${taskId}`);
        const statusData = await statusRes.json();

        if (statusData.status === "done") {
          summaryBox.textContent = statusData.summary;
          summarizeBtn.disabled = false;
          summarizeBtn.textContent = "Summarize";
        } else if (statusData.status === "error") {
          summaryBox.textContent = "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: " + statusData.message;
          summarizeBtn.disabled = false;
          summarizeBtn.textContent = "Summarize";
        } else {
          attempts++;
          if (attempts >= maxAttempts) {
            summaryBox.textContent = "âš ï¸ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ.";
            summarizeBtn.disabled = false;
            summarizeBtn.textContent = "Summarize";
          } else {
            setTimeout(pollStatus, 3000);
          }
        }
      }

      pollStatus();

    } catch (err) {
      console.error("Summarize error:", err);
      summaryBox.textContent = "ðŸš¨ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸ Ð¸Ð»Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°.";
      summarizeBtn.disabled = false;
      summarizeBtn.textContent = "Summarize";
    }
  });
}



// ----- WebSocket -----
window.socket = new WebSocket(
  (window.location.protocol === "https:" ? "wss://" : "ws://")
  + window.location.host
  + "/ws/posts/{{ post.pk }}/"
);

window.socket.onopen = () => console.log("âœ… WS connected");
window.socket.onclose = (e) => console.warn("âš ï¸ WS closed", e);
window.socket.onerror = (err) => console.error("âŒ WS error", err);


const postId = "{{ post.pk }}";
const socket = new WebSocket(
  (window.location.protocol === "https:" ? "wss://" : "ws://")
  + window.location.host
  + "/ws/posts/" + postId + "/"
);

socket.onopen = () => console.log("âœ… WS connected");

socket.onmessage = (e) => {
  console.log("ðŸ“© got from WS:", e.data);
  const data = JSON.parse(e.data);
  console.log("âš¡ ÐÐ¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹:", data);

  if (data.comment && data.comment.html) {
    const commentId = `comment-${data.comment.id}`;
    if (!document.getElementById(commentId)) {
      commentsList.insertAdjacentHTML("afterbegin", data.comment.html);
      const newForm = document.querySelector(`#${commentId} .reply-form`);
      if (newForm) bindReplyForm(newForm);
    }
  }
};

socket.onerror = (err) => console.error("WebSocket Ð¾ÑˆÐ¸Ð±ÐºÐ°:", err);
socket.onclose = (e) => console.warn("WebSocket Ð·Ð°ÐºÑ€Ñ‹Ñ‚:", e);
</script>





{% endblock %}
