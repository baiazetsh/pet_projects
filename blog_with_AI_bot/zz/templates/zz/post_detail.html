{# post_detail.html #}
{% extends 'zz/base.html' %}
{% load i18n %}
{% load static %} 

{% block content %}
<h3>Post detail</h3>
<div class="post"></div>
  <div class="d-flex align-items-center mb-2">
      <!-- üî• –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ –∞–≤–∞—Ç–∞—Ä–∞ -->
      <img src="{{ post.author.profile.avatar_url }}"
          class="rounded-circle me-2 avatar-click avatar-img"
          alt="avatar"
          data-profile-id="{{ post.author.profile.pk }}">
      <!-- üî• –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ -->

      <strong>{{ post.author.profile.display_name }}</strong>
      <span class="text-muted small ms-2">{{ post.created_at|date:"d M Y H:i" }}</span>
  </div>

  <h3>{{ chapter.title }}</h3>
  <p>{{ chapter.description }}</p>

</div>

<div class="post">
  <h4>{{ post.title }}</h4>
  <p>{{ post.content }}</p>
  <p><small>{{ post.created_at }}</small></p>

  {% if post.pk %}
  <a href="{% url 'zz:post_update' post.pk %}" class="btn btn-secondary">Edit</a>

  <form action="{% url 'zz:post_delete' post.pk %}" method="post" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="btn btn-sm btn-outline-danger">
      Delete
    </button>
  </form>

  <!-- Summarize -->
  <button id="summarize-btn" class="btn btn-warning">Summarize</button>
  <div id="summary-box"></div>
  {% endif %}
</div>

<hr>

<!-- –ì–ª–∞–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
<h3>{% trans "Add a comment" %}</h3>
<form id="commentForm" method="post" action="{% url 'zz:post_detail' post.pk %}">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit" class="btn btn-primary">{% trans "Send" %}</button>
</form>

<hr>

<!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ —É–±–ª—é–¥–∫–∞ -->
<button id="ubludokBtn"
        data-url="{% url 'zz:summon_ubludok' post.pk %}"
        class="btn btn-danger">
  {% trans "Call the Ubludok" %}
</button>
<div id="ubludok-status" class="mt-2 text-muted"></div>
<hr>

<!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<h3>{% trans "Comments" %}</h3>
<ul id="comments-list">
  {% for comment in comments %}
    {% include "zz/_comment.html" with comment=comment %}
  {% empty %}
   <li>{% trans "No comments yet" %}</li>
  {% endfor %}
</ul>

<!-- üî• –º–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ —Å topic_detail.html) -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="profile-avatar" src="" alt="avatar" class="rounded mb-3" width="200"
             onerror="this.src='{% static 'images/default-avatar.png' %}'"> <!-- üî• fallback -->
        <h4 id="profile-name"></h4>
        <p id="profile-quote" class="fst-italic text-muted"></p>
        <p id="profile-bio"></p>
        <p id="profile-bot"></p>
      </div>

      <div class="modal-footer">
        <a id="profile-full-link" href="#" class="btn btn-outline-primary">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</a>
      </div>
    </div>
  </div>
</div>


<script>

<!-- üî• JS –¥–ª—è –º–æ–¥–∞–ª–∫–∏ -->

document.addEventListener("DOMContentLoaded", function() {
  const modal = new bootstrap.Modal(document.getElementById("profileModal"));
  const avatarElems = document.querySelectorAll(".avatar-click");

  avatarElems.forEach(avatar => {
    avatar.style.cursor = "pointer";

    avatar.addEventListener("click", () => {
      const profileId = avatar.dataset.profileId;

      fetch(`/users/api/profiles/${profileId}/`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          document.getElementById("profile-full-link").href = "/users/profile/" + data.id + "/";
          document.getElementById("profile-avatar").src = data.avatar_url || '{% static "images/default-avatar.png" %}';
          document.getElementById("profile-name").textContent = data.display_name || "Unknown";
          document.getElementById("profile-quote").textContent = data.quote || "";
          document.getElementById("profile-bio").textContent = data.bio || "";
          document.getElementById("profile-bot").textContent = data.is_bot ? "ü§ñ Bot" : "üë§ User";
          modal.show();
        })
        .catch(err => {
          console.error("‚ùå Profile load error:", err);
          alert("Failed to load profile.");
        });
    });
  });
});



// assume 'commentHtml' is rendered _comment.html from backend
function addComment(commentHtml) {
  const commentList = document.getElementById("comment-list");
  const temp = document.createElement("div");
  temp.innerHTML = commentHtml.trim();

  const newComment = temp.firstElementChild;
  newComment.classList.add("bg-yellow-100", "dark:bg-yellow-900", "animate-pulse");

  commentList.appendChild(newComment);

  setTimeout(() => {
    newComment.classList.remove("bg-yellow-100", "dark:bg-yellow-900", "animate-pulse");
  }, 2000);
}


const CSRF = document.querySelector("[name=csrfmiddlewaretoken]").value;
const commentsList = document.getElementById("comments-list");

// ----- –ì–ª–∞–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -----
const mainForm = document.getElementById("commentForm");
if (mainForm) {
  mainForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(mainForm);

    try {
      const res = await fetch(mainForm.action, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
        body: formData,
      });

      const data = await res.json();
      if (data.success) {
        mainForm.reset();
      } else {
        console.error("–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º—ã:", data.errors || data);
      }
    } catch (err) {
      console.error("–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–ª–∞–≤–Ω–æ–π —Ñ–æ—Ä–º—ã:", err);
    }
  });
}

// ----- Reply —Ñ–æ—Ä–º—ã -----
function bindReplyForm(form) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    try {
      const res = await fetch(window.location.pathname, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
        body: formData,
      });

      const data = await res.json();
      if (data.success) {
        form.reset();
      } else {
        console.error("–û—à–∏–±–∫–∞ —Ä–µ–ø–ª–∞—è:", data.errors || data);
      }
    } catch (err) {
      console.error("–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–ø–ª–∞—è:", err);
    }
  });
}
document.querySelectorAll(".reply-form").forEach(bindReplyForm);

// ----- –£–±–ª—é–¥–æ–∫ -----
const ubludokBtn = document.getElementById("ubludokBtn");
const statusBox = document.getElementById("ubludok-status");

if (ubludokBtn) {
  ubludokBtn.type = "button";

  ubludokBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    
    const url = ubludokBtn.dataset.url;
    statusBox.textContent = "‚ö° –ü—Ä–∏–∑—ã–≤–∞—é –Ω–µ–π—Ä–æ—É–±–ª—é–¥–∫–∞...";

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
      });

      const data = await res.json();
      if (data.success) {
        statusBox.textContent = "‚úÖ –£–±–ª—é–¥–æ–∫ –≤—ã–∑–≤–∞–Ω!";
      } else {
        statusBox.textContent = "‚ùå –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ —É–±–ª—é–¥–∫–∞.";
        console.error("–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞:", data);
      }
    } catch (err) {
      statusBox.textContent = "üö® –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —É–±–ª—é–¥–∫–∞.";
      console.error("–°–µ—Ç—å –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —É–±–ª—é–¥–∫–∞:", err);
    }
  });
}

// ----- Summarize -----

const summarizeBtn = document.getElementById("summarize-btn");
const summaryBox = document.getElementById("summary-box");

if (summarizeBtn) {
  summarizeBtn.addEventListener("click", async () => {
    summarizeBtn.disabled = true;
    summarizeBtn.textContent = "‚è≥ Summarizing...";
    summaryBox.textContent = "";

    try {
      const res = await fetch("{% url 'zz:post_summarize' post.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await res.json();
      if (!data.task_id) {
        summaryBox.textContent = "‚ùå –û—à–∏–±–∫–∞: –∑–∞–¥–∞—á–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞.";
        return;
      }

      const taskId = data.task_id;
      let attempts = 0;
      const maxAttempts = 80;

      async function pollStatus() {
        const statusRes = await fetch(`{% url 'zz:post_summarize' post.pk %}?task_id=${taskId}`);
        const statusData = await statusRes.json();

        if (statusData.status === "done") {
          summaryBox.textContent = statusData.summary;
          summarizeBtn.disabled = false;
          summarizeBtn.textContent = "Summarize";
        } else if (statusData.status === "error") {
          summaryBox.textContent = "‚ùå –û—à–∏–±–∫–∞: " + statusData.message;
          summarizeBtn.disabled = false;
          summarizeBtn.textContent = "Summarize";
        } else {
          attempts++;
          if (attempts >= maxAttempts) {
            summaryBox.textContent = "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.";
            summarizeBtn.disabled = false;
            summarizeBtn.textContent = "Summarize";
          } else {
            setTimeout(pollStatus, 3000);
          }
        }
      }

      pollStatus();

    } catch (err) {
      console.error("Summarize error:", err);
      summaryBox.textContent = "üö® –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.";
      summarizeBtn.disabled = false;
      summarizeBtn.textContent = "Summarize";
    }
  });
}




// ----- WebSocket -----
const postId = "{{ post.pk }}";
const socket = new WebSocket(
¬† (window.location.protocol === "https:" ? "wss://" : "ws://")
¬† + window.location.host
¬† + "/ws/posts/" + postId + "/"
);

socket.onopen = () => console.log("‚úÖ WS connected");
socket.onerror = (err) => console.error("‚ùå WS error", err);
socket.onclose = (e) => console.warn("‚ö†Ô∏è WS closed", e);

// üî• –ó–ê–ú–ï–ù–ò–¢–ï –í–ï–°–¨ –°–¢–ê–†–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö `socket.onmessage` –ù–ê –≠–¢–û–¢
socket.onmessage = (e) => {
¬† const data = JSON.parse(e.data);
¬† console.log("‚ö° –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:", data);

¬† // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
¬† if (document.getElementById(`comment-${data.comment_id}`)) {
¬† ¬† return;
¬† }

¬† const commentHtml = data.comment_html;
¬† const parentId = data.parent_id;
  const commentsList = document.getElementById("comments-list");

¬† if (parentId) {
¬† ¬† // –≠–¢–û –û–¢–í–ï–¢ (REPLY)
¬† ¬† const parentComment = document.getElementById(`comment-${parentId}`);
¬† ¬† if (parentComment) {
¬† ¬† ¬† // –ò—â–µ–º –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ <ul>
¬† ¬† ¬† let repliesList = parentComment.querySelector("ul");
¬† ¬† ¬† if (!repliesList) {
¬† ¬† ¬† ¬† // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç, —Å–ø–∏—Å–∫–∞ <ul> –µ—â–µ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
¬† ¬† ¬† ¬† repliesList = document.createElement("ul");
¬† ¬† ¬† ¬† repliesList.className = "list-unstyled ms-4 mt-3";
¬† ¬† ¬† ¬† // –í—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—è
¬† ¬† ¬† ¬† parentComment.querySelector(".reply-form").insertAdjacentElement("afterend", repliesList);
¬† ¬† ¬† }
¬† ¬† ¬† // –î–æ–±–∞–≤–ª—è–µ–º HTML –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞
¬† ¬† ¬† repliesList.insertAdjacentHTML("beforeend", commentHtml);
¬† ¬† }
¬† } else {
¬† ¬† // –≠–¢–û –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –í–ï–†–•–ù–ï–ì–û –£–†–û–í–ù–Ø
¬† ¬† commentsList.insertAdjacentHTML("afterbegin", commentHtml);
¬† }
  
  // üî• –í–ê–ñ–ù–û: –Ω—É–∂–Ω–æ "–æ–∂–∏–≤–∏—Ç—å" —Ñ–æ—Ä–º—É –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
  const newCommentElement = document.getElementById(`comment-${data.comment_id}`);
  if (newCommentElement) {
    const newReplyForm = newCommentElement.querySelector(".reply-form");
    if (newReplyForm) {
      bindReplyForm(newReplyForm); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
    }
  }
};

</script>


{% endblock %}
