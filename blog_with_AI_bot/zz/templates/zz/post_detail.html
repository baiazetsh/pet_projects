{# post_detail.html #}
{% extends 'zz/base.html' %}
{% load i18n %}
{% load static %} 

{% block content %}
<h3>Post detail</h3>
<div class="post"></div>
  <div class="d-flex align-items-center mb-2">
      <!-- ğŸ”¥ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ±Ğ»Ğ¾Ğº Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ° -->
      <img src="{{ post.author.profile.avatar_url }}"
          class="rounded-circle me-2 avatar-click avatar-img"
          alt="avatar"
          data-profile-id="{{ post.author.profile.pk }}">
      <!-- ğŸ”¥ ĞºĞ¾Ğ½ĞµÑ† Ğ±Ğ»Ğ¾ĞºĞ° Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ° -->

      <strong>{{ post.author.profile.display_name }}</strong>
      <span class="text-muted small ms-2">{{ post.created_at|date:"d M Y H:i" }}</span>
  </div>

  <h3>{{ chapter.title }}</h3>
  <p>{{ chapter.description }}</p>

</div>

<div class="post">
  <h4>{{ post.title }}</h4>
  <p>{{ post.content }}</p>
  <p><small>{{ post.created_at }}</small></p>

  {% if post.pk %}
  <a href="{% url 'zz:post_update' post.pk %}" class="btn btn-secondary">Edit</a>

  <form action="{% url 'zz:post_delete' post.pk %}" method="post" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="btn btn-sm btn-outline-danger">
      Delete
    </button>
  </form>

  <!-- Summarize -->
  <button id="summarize-btn" class="btn btn-warning">Summarize</button>
  <div id="summary-box"></div>
  {% endif %}
</div>

<hr>

<!-- Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ° -->
<h3>{% trans "Add a comment" %}</h3>
<form id="commentForm" method="post" action="{% url 'zz:post_detail' post.pk %}">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit" class="btn btn-primary">{% trans "Send" %}</button>
</form>

<hr>

<!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ° ÑƒĞ±Ğ»ÑĞ´ĞºĞ° -->
<button id="ubludokBtn"
        data-url="{% url 'zz:summon_ubludok' post.pk %}"
        class="btn btn-danger">
  {% trans "Call the Ubludok" %}
</button>
<div id="ubludok-status" class="mt-2 text-muted"></div>
<hr>

<!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ² -->
<h3>{% trans "Comments" %}</h3>
<ul id="comments-list">
  {% for comment in comments %}
    {% include "zz/_comment.html" with comment=comment %}
  {% empty %}
   <li>{% trans "No comments yet" %}</li>
  {% endfor %}
</ul>

<!-- ğŸ”¥ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ (ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ñ topic_detail.html) -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="profile-avatar" src="" alt="avatar" class="rounded mb-3" width="200"
             onerror="this.src='{% static 'images/default-avatar.png' %}'"> <!-- ğŸ”¥ fallback -->
        <h4 id="profile-name"></h4>
        <p id="profile-quote" class="fst-italic text-muted"></p>
        <p id="profile-bio"></p>
        <p id="profile-bot"></p>
      </div>

      <div class="modal-footer">
        <a id="profile-full-link" href="#" class="btn btn-outline-primary">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</a>
      </div>
    </div>
  </div>
</div>


<script>

<!-- ğŸ”¥ JS Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ¸ -->

document.addEventListener("DOMContentLoaded", function() {
  const modal = new bootstrap.Modal(document.getElementById("profileModal"));
  const avatarElems = document.querySelectorAll(".avatar-click");

  avatarElems.forEach(avatar => {
    avatar.style.cursor = "pointer";

    avatar.addEventListener("click", () => {
      const profileId = avatar.dataset.profileId;

      fetch(`/users/api/profiles/${profileId}/`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          document.getElementById("profile-full-link").href = "/users/profile/" + data.id + "/";
          document.getElementById("profile-avatar").src = data.avatar_url || '{% static "images/default-avatar.png" %}';
          document.getElementById("profile-name").textContent = data.display_name || "Unknown";
          document.getElementById("profile-quote").textContent = data.quote || "";
          document.getElementById("profile-bio").textContent = data.bio || "";
          document.getElementById("profile-bot").textContent = data.is_bot ? "ğŸ¤– Bot" : "ğŸ‘¤ User";
          modal.show();
        })
        .catch(err => {
          console.error("âŒ Profile load error:", err);
          alert("Failed to load profile.");
        });
    });
  });
});



// assume 'commentHtml' is rendered _comment.html from backend
function addComment(commentHtml) {
  const commentList = document.getElementById("comment-list");
  const temp = document.createElement("div");
  temp.innerHTML = commentHtml.trim();

  const newComment = temp.firstElementChild;
  newComment.classList.add("bg-yellow-100", "dark:bg-yellow-900", "animate-pulse");

  commentList.appendChild(newComment);

  setTimeout(() => {
    newComment.classList.remove("bg-yellow-100", "dark:bg-yellow-900", "animate-pulse");
  }, 2000);
}


const CSRF = document.querySelector("[name=csrfmiddlewaretoken]").value;
const commentsList = document.getElementById("comments-list");

// ----- Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ° -----
const mainForm = document.getElementById("commentForm");
if (mainForm) {
  mainForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(mainForm);

    try {
      const res = await fetch(mainForm.action, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
        body: formData,
      });

      const data = await res.json();
      if (data.success) {
        mainForm.reset();
      } else {
        console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹:", data.errors || data);
      }
    } catch (err) {
      console.error("Ğ¡ĞµÑ‚ÑŒ/ÑĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ñ‹:", err);
    }
  });
}

// ----- Reply Ñ„Ğ¾Ñ€Ğ¼Ñ‹ -----
function bindReplyForm(form) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    try {
      const res = await fetch(window.location.pathname, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
        body: formData,
      });

      const data = await res.json();
      if (data.success) {
        form.reset();
      } else {
        console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ¿Ğ»Ğ°Ñ:", data.errors || data);
      }
    } catch (err) {
      console.error("Ğ¡ĞµÑ‚ÑŒ/ÑĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ñ€ĞµĞ¿Ğ»Ğ°Ñ:", err);
    }
  });
}
document.querySelectorAll(".reply-form").forEach(bindReplyForm);

// ----- Ğ£Ğ±Ğ»ÑĞ´Ğ¾Ğº -----
const ubludokBtn = document.getElementById("ubludokBtn");
const statusBox = document.getElementById("ubludok-status");

if (ubludokBtn) {
  ubludokBtn.type = "button";

  ubludokBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    
    const url = ubludokBtn.dataset.url;
    statusBox.textContent = "âš¡ ĞŸÑ€Ğ¸Ğ·Ñ‹Ğ²Ğ°Ñ Ğ½ĞµĞ¹Ñ€Ğ¾ÑƒĞ±Ğ»ÑĞ´ĞºĞ°...";

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": CSRF,
        },
      });

      const data = await res.json();
      if (data.success) {
        statusBox.textContent = "âœ… Ğ£Ğ±Ğ»ÑĞ´Ğ¾Ğº Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½!";
      } else {
        statusBox.textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ° ÑƒĞ±Ğ»ÑĞ´ĞºĞ°.";
        console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°:", data);
      }
    } catch (err) {
      statusBox.textContent = "ğŸš¨ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ ÑƒĞ±Ğ»ÑĞ´ĞºĞ°.";
      console.error("Ğ¡ĞµÑ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ ÑƒĞ±Ğ»ÑĞ´ĞºĞ°:", err);
    }
  });
}

// ----- Summarize -----

const summarizeBtn = document.getElementById("summarize-btn");
const summaryBox = document.getElementById("summary-box");

if (summarizeBtn) {
  summarizeBtn.addEventListener("click", async () => {
    summarizeBtn.disabled = true;
    summarizeBtn.textContent = "â³ Summarizing...";
    summaryBox.textContent = "";

    try {
      const res = await fetch("{% url 'zz:post_summarize' post.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await res.json();
      if (!data.task_id) {
        summaryBox.textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ°.";
        return;
      }

      const taskId = data.task_id;
      let attempts = 0;
      const maxAttempts = 80;

      async function pollStatus() {
        const statusRes = await fetch(`{% url 'zz:post_summarize' post.pk %}?task_id=${taskId}`);
        const statusData = await statusRes.json();

        if (statusData.status === "done") {
          summaryBox.textContent = statusData.summary;
          summarizeBtn.disabled = false;
          summarizeBtn.textContent = "Summarize";
        } else if (statusData.status === "error") {
          summaryBox.textContent = "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: " + statusData.message;
          summarizeBtn.disabled = false;
          summarizeBtn.textContent = "Summarize";
        } else {
          attempts++;
          if (attempts >= maxAttempts) {
            summaryBox.textContent = "âš ï¸ ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ.";
            summarizeBtn.disabled = false;
            summarizeBtn.textContent = "Summarize";
          } else {
            setTimeout(pollStatus, 3000);
          }
        }
      }

      pollStatus();

    } catch (err) {
      console.error("Summarize error:", err);
      summaryBox.textContent = "ğŸš¨ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸ Ğ¸Ğ»Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ°.";
      summarizeBtn.disabled = false;
      summarizeBtn.textContent = "Summarize";
    }
  });
}




// ----- WebSocket -----
const postId = "{{ post.pk }}";
const socket = new WebSocket(
Â  (window.location.protocol === "https:" ? "wss://" : "ws://")
Â  + window.location.host
Â  + "/ws/posts/" + postId + "/"
);

socket.onopen = () => console.log("âœ… WS connected");
socket.onerror = (err) => console.error("âŒ WS error", err);
socket.onclose = (e) => console.warn("âš ï¸ WS closed", e);

// ğŸ”¥ Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ• Ğ’Ğ•Ğ¡Ğ¬ Ğ¡Ğ¢ĞĞ Ğ«Ğ™ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜Ğš `socket.onmessage` ĞĞ Ğ­Ğ¢ĞĞ¢
socket.onmessage = (e) => {
Â  const data = JSON.parse(e.data);
Â  console.log("âš¡ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹:", data);

Â  // 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½ĞµÑ‚ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ñ‚Ğ°ĞºĞ¾Ğ³Ğ¾ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ñ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ
Â  if (document.getElementById(`comment-${data.comment_id}`)) {
Â  Â  return;
Â  }

Â  const commentHtml = data.comment_html;
Â  const parentId = data.parent_id;
  const commentsList = document.getElementById("comments-list");

Â  if (parentId) {
Â  Â  // Ğ­Ğ¢Ğ ĞĞ¢Ğ’Ğ•Ğ¢ (REPLY)
Â  Â  const parentComment = document.getElementById(`comment-${parentId}`);
Â  Â  if (parentComment) {
Â  Â  Â  // Ğ˜Ñ‰ĞµĞ¼ Ğ² Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ¼ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² <ul>
Â  Â  Â  let repliesList = parentComment.querySelector("ul");
Â  Â  Â  if (!repliesList) {
Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚, ÑĞ¿Ğ¸ÑĞºĞ° <ul> ĞµÑ‰Ğµ Ğ½ĞµÑ‚, ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞµĞ³Ğ¾
Â  Â  Â  Â  repliesList = document.createElement("ul");
Â  Â  Â  Â  repliesList.className = "list-unstyled ms-4 mt-3";
Â  Â  Â  Â  // Ğ’ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ
Â  Â  Â  Â  parentComment.querySelector(".reply-form").insertAdjacentElement("afterend", repliesList);
Â  Â  Â  }
Â  Â  Â  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ HTML Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ² ĞºĞ¾Ğ½ĞµÑ† ÑĞ¿Ğ¸ÑĞºĞ°
Â  Â  Â  repliesList.insertAdjacentHTML("beforeend", commentHtml);
Â  Â  }
Â  } else {
Â  Â  // Ğ­Ğ¢Ğ ĞšĞĞœĞœĞ•ĞĞ¢ĞĞ Ğ˜Ğ™ Ğ’Ğ•Ğ Ğ¥ĞĞ•Ğ“Ğ Ğ£Ğ ĞĞ’ĞĞ¯
Â  Â  commentsList.insertAdjacentHTML("afterbegin", commentHtml);
Â  }
  
  // ğŸ”¥ Ğ’ĞĞ–ĞĞ: Ğ½ÑƒĞ¶Ğ½Ğ¾ "Ğ¾Ğ¶Ğ¸Ğ²Ğ¸Ñ‚ÑŒ" Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ² Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ¼ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸.
  const newCommentElement = document.getElementById(`comment-${data.comment_id}`);
  if (newCommentElement) {
    const newReplyForm = newCommentElement.querySelector(".reply-form");
    if (newReplyForm) {
      bindReplyForm(newReplyForm); // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ²Ğ°ÑˆÑƒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
    }
  }
};

</script>


{% endblock %}
