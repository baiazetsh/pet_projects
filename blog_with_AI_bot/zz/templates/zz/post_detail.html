{# post_detail.html #}
{% extends 'zz/base.html' %}
{% load i18n %}
{% load static %} 

{% block content %}
<h3>Post detail</h3>
<div class="post"></div>
  <div class="d-flex align-items-center mb-2">
      <!-- üî• –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ –∞–≤–∞—Ç–∞—Ä–∞ -->
      <img src="{{ post.author.profile.avatar_url }}"
          class="rounded-circle me-2 avatar-click avatar-img"
          alt="avatar"
          data-profile-id="{{ post.author.profile.pk }}">
      <!-- üî• –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ -->

      <strong>{{ post.author.profile.display_name }}</strong>
      <span class="text-muted small ms-2">{{ post.created_at|date:"d M Y H:i" }}</span>
  </div>

  <h3>{{ chapter.title }}</h3>
  <p>{{ chapter.description }}</p>

</div>

<div class="post">
  <h4>{{ post.title }}</h4>
  <p>{{ post.content }}</p>
  <p><small>{{ post.created_at }}</small></p>

  {% if post.pk %}
  <a href="{% url 'zz:post_update' post.pk %}" class="btn btn-secondary">Edit</a>

  <form action="{% url 'zz:post_delete' post.pk %}" method="post" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="btn btn-sm btn-outline-danger">
      Delete
    </button>
  </form>

  <!-- Summarize -->
  <button id="summarize-btn"
          class="btn btn-warning mt-2"
          data-post-id="{{ post.id }}">
          Summarize
  </button>
  <div id="summary-box"
      class="alert alert-secondary mt-3 d-none"
      role="alert">
  </div>
  {% endif %}
</div>

<hr>

<!-- –ì–ª–∞–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
<h3>{% trans "Add a comment" %}</h3>
<form id="commentForm" method="post" action="{% url 'zz:post_detail' post.pk %}">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit" class="btn btn-primary">{% trans "Send" %}</button>
</form>

<hr>

<!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ —É–±–ª—é–¥–∫–∞ -->
<button id="ubludokBtn"
        data-url="{% url 'zz:summon_ubludok' post.pk %}"
        class="btn btn-danger">
  {% trans "Call the Ubludok" %}
</button>
<div id="ubludok-status" class="mt-2 text-muted"></div>
<hr>

<!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<h3>{% trans "Comments" %}</h3>
<ul id="comments-list">
  {% for comment in comments %}
    {% include "zz/_comment.html" with comment=comment %}
  {% empty %}
   <li>{% trans "No comments yet" %}</li>
  {% endfor %}
</ul>

<!-- üî• –º–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ —Å topic_detail.html) -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="profile-avatar" src="" alt="avatar" class="rounded mb-3" width="200"
             onerror="this.src='{% static 'images/default-avatar.png' %}'"> <!-- üî• fallback -->
        <h4 id="profile-name"></h4>
        <p id="profile-quote" class="fst-italic text-muted"></p>
        <p id="profile-bio"></p>
        <p id="profile-bot"></p>
      </div>

      <div class="modal-footer">
        <a id="profile-full-link" href="#" class="btn btn-outline-primary">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</a>
      </div>
    </div>
  </div>
</div>


<script>
// üü¢ FIX 1: –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è getCookie (–¥–ª—è CSRF)
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// üü¢ FIX 2: –∑–∞–º–µ–Ω–µ–Ω–æ –¥–≤–∞ DOMContentLoaded ‚Üí –Ω–∞ –æ–¥–∏–Ω –æ–±—â–∏–π init
document.addEventListener("DOMContentLoaded", function() {
  initProfileModal();
  initCommentForms();
  initUbludokButton();
  initSummarizeButton();
  initWebSocket();
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   üß© –ú–û–î–ê–õ–ö–ê –ü–†–û–§–ò–õ–Ø
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function initProfileModal() {
  const modal = new bootstrap.Modal(document.getElementById("profileModal"));
  const avatars = document.querySelectorAll(".avatar-click");

  avatars.forEach(avatar => {
    avatar.style.cursor = "pointer";
    avatar.addEventListener("click", () => {
      const id = avatar.dataset.profileId;
      fetch(`/users/api/profiles/${id}/`)
        .then(r => r.json())
        .then(data => {
          document.getElementById("profile-full-link").href = `/users/profile/${data.id}/`;
          document.getElementById("profile-avatar").src = data.avatar_url || '{% static "images/default-avatar.png" %}';
          document.getElementById("profile-name").textContent = data.display_name || "Unknown";
          document.getElementById("profile-quote").textContent = data.quote || "";
          document.getElementById("profile-bio").textContent = data.bio || "";
          document.getElementById("profile-bot").textContent = data.is_bot ? "ü§ñ Bot" : "üë§ User";
          modal.show();
        })
        .catch(err => console.error("Profile error:", err));
    });
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   üí¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function initCommentForms() {
  const CSRF = document.querySelector("[name=csrfmiddlewaretoken]").value;
  const mainForm = document.getElementById("commentForm");
  if (!mainForm) return;

  mainForm.addEventListener("submit", async e => {
    e.preventDefault();
    const formData = new FormData(mainForm);
    const res = await fetch(mainForm.action, {
      method: "POST",
      headers: { "X-CSRFToken": CSRF, "X-Requested-With": "XMLHttpRequest" },
      body: formData
    });
    const data = await res.json();
    if (data.success) mainForm.reset();
  });

  document.querySelectorAll(".reply-form").forEach(form => bindReplyForm(form, CSRF));
}

function bindReplyForm(form, CSRF) {
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const formData = new FormData(form);
    const res = await fetch(window.location.pathname, {
      method: "POST",
      headers: { "X-CSRFToken": CSRF, "X-Requested-With": "XMLHttpRequest" },
      body: formData
    });
    const data = await res.json();
    if (data.success) form.reset();
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ü§ñ –£–ë–õ–Æ–î–û–ö
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function initUbludokButton() {
  const btn = document.getElementById("ubludokBtn");
  if (!btn) return;
  const box = document.getElementById("ubludok-status");
  const CSRF = document.querySelector("[name=csrfmiddlewaretoken]").value;

  btn.addEventListener("click", async e => {
    e.preventDefault();
    box.textContent = "‚ö° –ü—Ä–∏–∑—ã–≤–∞—é –Ω–µ–π—Ä–æ—É–±–ª—é–¥–∫–∞...";
    try {
      const res = await fetch(btn.dataset.url, {
        method: "POST",
        headers: { "X-CSRFToken": CSRF, "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await res.json();
      box.textContent = data.success ? "‚úÖ –£–±–ª—é–¥–æ–∫ –≤—ã–∑–≤–∞–Ω!" : "‚ùå –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞.";
    } catch (err) {
      box.textContent = "üö® –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —É–±–ª—é–¥–∫–∞.";
    }
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   üß† SUMMARIZE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function initSummarizeButton() {
  const btn = document.getElementById("summarize-btn");
  const box = document.getElementById("summary-box");
  if (!btn || !box) return;
  const postId = btn.dataset.postId;

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    btn.innerText = "‚è≥ Summarizing...";
    box.classList.remove("d-none");
    box.innerHTML = "<em>Request sent to AI...</em>";

    try {
      const start = await fetch(`/posts/${postId}/summarize/`, {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") }
      });
      const data = await start.json();

      if (data.status === "cached") {
        box.innerHTML = `<p>${data.summary}</p><small class="text-muted">(from cache)</small>`;
        btn.innerText = "Summarize again";
        btn.disabled = false;
        return;
      }

      const taskId = data.task_id;
      box.innerHTML = `<em>ü§ñ Model is thinking...</em>`;

      const poll = setInterval(async () => {
        const r = await fetch(`/posts/${postId}/summarize/?task_id=${taskId}`);
        const s = await r.json();

        if (s.status === "done") {
          clearInterval(poll);
          // üü¢ FIX 3: –¥–æ–±–∞–≤–ª–µ–Ω fade-in —ç—Ñ—Ñ–µ–∫—Ç
          box.innerHTML = `<p class="fade-in">${s.summary}</p>
                           <small class="text-success">(AI generated)</small>`;
          btn.innerText = "Summarize again";
          btn.disabled = false;
        } else if (s.status === "error") {
          clearInterval(poll);
          box.innerHTML = `<p class="text-danger">‚ùå ${s.message}</p>`;
          btn.innerText = "Try again";
          btn.disabled = false;
        } else if (s.status === "running") {
          box.innerHTML = "<em>üß© Still processing...</em>";
        }
      }, 2000);
    } catch (err) {
      box.innerHTML = `<p class="text-danger">Network error: ${err}</p>`;
      btn.innerText = "Summarize again";
      btn.disabled = false;
    }
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   üåê WEBSOCKET
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function initWebSocket() {
  // üü¢ FIX 4: –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å postId
  const WS_POST_ID = "{{ post.pk }}";
  const socket = new WebSocket(
    (window.location.protocol === "https:" ? "wss://" : "ws://")
    + window.location.host
    + "/ws/posts/" + WS_POST_ID + "/"
  );

  socket.onopen = () => console.log("‚úÖ WS connected");
  socket.onerror = (err) => console.error("‚ùå WS error", err);
  socket.onclose = (e) => console.warn("‚ö†Ô∏è WS closed", e);

  socket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log("‚ö° New comment:", data);

    if (document.getElementById(`comment-${data.comment_id}`)) return;
    const commentHtml = data.comment_html;
    const parentId = data.parent_id;
    const commentsList = document.getElementById("comments-list");

    if (parentId) {
      const parent = document.getElementById(`comment-${parentId}`);
      if (parent) {
        let replies = parent.querySelector("ul");
        if (!replies) {
          replies = document.createElement("ul");
          replies.className = "list-unstyled ms-4 mt-3";
          parent.querySelector(".reply-form").insertAdjacentElement("afterend", replies);
        }
        replies.insertAdjacentHTML("beforeend", commentHtml);
      }
    } else {
      commentsList.insertAdjacentHTML("afterbegin", commentHtml);
    }

    const newEl = document.getElementById(`comment-${data.comment_id}`);
    if (newEl) {
      const newReplyForm = newEl.querySelector(".reply-form");
      if (newReplyForm) bindReplyForm(newReplyForm, getCookie("csrftoken"));
    }
  };
}
</script>

<!--  fade-in CSS -->
<style>
.fade-in {
  animation: fadeIn 0.5s ease-in-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>



{% endblock %}
