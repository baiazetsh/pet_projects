{# index.html #}
{% extends "zz/base.html" %}
{% block content %}
{% load static %} 

<div class="container mt-4">
  <h1 class="mb-4">üìö All topics</h1>

  <div class="list-group">
    {% for topic in topics %}
      <div class="list-group-item flex-column align-items-start mb-2 shadow-sm rounded">
        <div class="d-flex w-100 justify-content-between align-items-center">
          <h5 class="mb-1">{{ topic.name }}</h5>
          <small class="text-muted">{{ topic.created_at|date:"M d, Y" }}</small>
        </div>

         <!-- üî• –∑–∞–º–µ–Ω–∏–ª–∏ username –Ω–∞ –∞–≤–∞—Ç–∞—Ä + –∏–º—è -->
        <div class="d-flex align-items-center mb-2">
          <img src="{{ topic.owner.profile.avatar_url }}"
               class="rounded-circle me-2 avatar-click avatar-img"
               alt="avatar"
               width="32" height="32"
               data-profile-id="{{ topic.owner.profile.pk }}"
               onerror="this.src='{% static 'images/default-avatar.png' %}'">
          <p class="mb-0 text-muted">
            by <strong>{{ topic.owner.profile.display_name }}</strong>
          </p>
        </div>
        <!-- üî• –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ -->

        
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è -->
        <button class="btn btn-sm btn-outline-primary mb-2 d-flex align-items-center"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#chapters-{{ topic.pk }}"
                aria-expanded="false"
                aria-controls="chapters-{{ topic.pk }}">
          <span class="me-1">üìò {{ topic.chapters.count }} chapters</span>
          <i class="bi bi-chevron-down collapse-icon"></i>
        </button>

        <!-- –°–ø–∏—Å–æ–∫ –≥–ª–∞–≤ (accordion-style) -->
        <div class="collapse" id="chapters-{{ topic.pk }}">
          <ul class="list-group list-group-flush mt-2">
            {% for chapter in topic.chapters.all %}
              <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ chapter.title }}</strong><br>
                  <small class="text-muted"> Description of  chapter: {{ chapter.description|truncatewords:15 }}</small>
                </div>
                <span class="badge bg-info ms-2">{{ chapter.posts.count }} posts</span>
                
              </li>
            {% empty %}
              <li class="list-group-item text-muted">No chapters yet</li>
            {% endfor %}
          </ul>

          <!-- üî• –≤—ã–≤–æ–¥–∏–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –ø–æ —Ç–µ–º–µ -->
          <div class="mt-2 text-muted">
            Total posts in topic: {{ topic.total_posts }}
          </div>

        </div>

        <div class="mt-2">
          <a href="{% url 'zz:topic_detail' topic.pk %}" class="btn btn-sm btn-success">
            View Topic
          </a>
        </div>
      </div>
    {% empty %}
      <p class="text-muted">No topics found.</p>
    {% endfor %}
  </div>
</div>

<style>
/* –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–æ—á–∫–∏ */
.collapse-icon {
  transition: transform 0.3s ease;
}
button[aria-expanded="true"] .collapse-icon {
  transform: rotate(180deg);
}
</style>


<!-- üî• –º–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (–æ–¥–Ω–∞ –Ω–∞ –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É) -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="profile-avatar" src="" alt="avatar" class="rounded mb-3" width="200"
             onerror="this.src='{% static 'images/default-avatar.png' %}'">
        <h4 id="profile-name"></h4>
        <p id="profile-quote" class="fst-italic text-muted"></p>
        <p id="profile-bio"></p>
        <p id="profile-bot"></p>
      </div>
      <div class="modal-footer">
        <a id="profile-full-link" href="#" class="btn btn-outline-primary">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</a>
      </div>
    </div>
  </div>
</div>

<!-- üî• JS -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const modal = new bootstrap.Modal(document.getElementById("profileModal"));
  const avatarElems = document.querySelectorAll(".avatar-click");

  avatarElems.forEach(avatar => {
    avatar.style.cursor = "pointer";

    avatar.addEventListener("click", () => {
      const profileId = avatar.dataset.profileId;

      fetch(`/users/api/profiles/${profileId}/`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          document.getElementById("profile-full-link").href = "/users/profile/" + data.id + "/";
          document.getElementById("profile-avatar").src = data.avatar_url || '{% static "images/default-avatar.png" %}';
          document.getElementById("profile-name").textContent = data.display_name || "Unknown";
          document.getElementById("profile-quote").textContent = data.quote || "";
          document.getElementById("profile-bio").textContent = data.bio || "";
          document.getElementById("profile-bot").textContent = data.is_bot ? "ü§ñ Bot" : "üë§ User";
          modal.show();
        })
        .catch(err => {
          console.error("‚ùå Profile load error:", err);
          alert("Failed to load profile.");
        });
    });
  });
});
</script>





{% endblock %}
