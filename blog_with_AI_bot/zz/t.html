{# templates/zz/_comment.html #}
{% load i18n %}
{% load static %}

<li id="comment-{{ comment.id }}" class="transition-all duration-500 ease-in-out animate-fade-in mb-3">
  <div class="d-flex align-items-center mb-1">
    <!-- üî• –∞–≤–∞—Ç–∞—Ä + –∏–º—è –∞–≤—Ç–æ—Ä–∞ -->
    <img src="{{ comment.author.profile.avatar_url }}"
         class="rounded-circle me-2 avatar-click avatar-img"
         alt="avatar"
         width="32" height="32"
         data-profile-id="{{ comment.author.profile.pk }}"
         onerror="this.src='{% static 'images/default-avatar.png' %}'">
    <div>
      <strong>{{ comment.author.profile.display_name }}</strong>
      <small class="text-muted ms-2">{{ comment.created_at|date:"SHORT_DATETIME_FORMAT" }}</small>
    </div>
  </div>

  {% if comment.parent %}
    <div class="text-muted mb-1">
      <small><em>
        {{ comment.parent.author.profile.display_name }}:  
        {{ comment.parent.content|truncatechars:50 }}
      </em></small>
    </div>
  {% elif comment.parent_id %}
    <div class="text-muted mb-1">
      <small><em>{% trans "Quote was deleted" %}</em></small>
    </div>
  {% endif %}

  <p>{{ comment.content }}</p>

  <!-- Reply form -->
  <form method="post" class="reply-form mt-2">
    {% csrf_token %}
    <input type="hidden" name="parent_id" value="{{ comment.id }}">
    <textarea name="content"
              class="form-control mb-2"
              rows="2"
              placeholder="{% trans 'Reply...' %}"></textarea>
    <button type="submit" class="btn btn-primary btn-sm">
      {% trans "Reply" %}
    </button>
  </form>

  <!-- Nested replies -->
  {% if comment.replies.exists %}
    <ul class="list-unstyled ms-4 mt-3">
      {% for reply in comment.replies.all %}
        {% include "zz/_comment.html" with comment=reply %}
      {% endfor %}
    </ul>
  {% endif %}
</li>
// ----- WebSocket -----
const postId = "{{ post.pk }}";
const socket = new WebSocket(
  (window.location.protocol === "https:" ? "wss://" : "ws://")
  + window.location.host
  + "/ws/posts/" + postId + "/"
);

socket.onopen = () => console.log("‚úÖ WS connected");
socket.onerror = (err) => console.error("‚ùå WS error", err);
socket.onclose = (e) => console.warn("‚ö†Ô∏è WS closed", e);

socket.onmessage = (e) => {
  const data = JSON.parse(e.data);
  console.log("‚ö° –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:", data);

  // üü© –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
  if (document.querySelector(`[data-comment-id="${data.id}"]`)) return;

  // üü© –∞–≤–∞—Ç–∞—Ä –∏–ª–∏ fallback
  const avatar = data.author_profile?.avatar
    ? data.author_profile.avatar
    : "{% static 'images/default-avatar.png' %}";

  const username = data.author_username || "Unknown";
  const quote = data.author_profile?.quote || "";
  const createdAt = new Date(data.created_at).toLocaleString();
  const content = data.content;

  // üü© —Ñ–æ—Ä–º–∏—Ä—É–µ–º HTML –±–ª–æ–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
  const html = `
    <li class="comment small mb-2 d-flex align-items-center" data-comment-id="${data.id}">
      <img src="${avatar}"
           class="rounded-circle me-2 avatar-click avatar-img"
           alt="avatar"
           width="32" height="32"
           onerror="this.src='{% static 'images/default-avatar.png' %}'">
      <div>
        <strong>${username}</strong>
        <span class="text-muted small ms-2">${createdAt}</span><br>
        <span class="text-body">${content}</span>
        ${quote ? `<div class="text-muted fst-italic mt-1">"${quote}"</div>` : ""}
      </div>
    </li>
  `;

  // üü© –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
  commentsList.insertAdjacentHTML("afterbegin", html);
};
